<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>%</title>
</head>

<body class="flex">
<div id="root">

</div>

<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="index.js"></script>
<script>
	//spreadsheetにlog入力
	var spreadsheet = SpreadsheetApp.openById("1jNLfOw3hGqqZqCifeLSgfXbAiRvFBaC_pUuPVdo7JQs");
	//access_token(LINE Developerから取得)
	var channel_access_token = "4483920e-916b-4be7-9375-1116e27c866c";

	//postで取得
	function doPost(e) {
		var webhookData = JSON.parse(e.postData.contents).events[0];
		var replyToken, img, time, message;
		time = new Date(webhookData.timestamp);
		message = webhookData.message.text;
		replyToken = webhookData.replyToken;


//groupなら
		if (webhookData.source.type == "room") {
			var groupId = webhookData.source.roomId;
			var userId = webhookData.source.userId;


//groupIDのシートがなかったら生成
			if (spreadsheet.getSheetByName(groupId) == null) {
				var newsheet = spreadsheet.insertSheet(groupId);
				newsheet.appendRow(["사용자이름", "time", "message"]); // 最初一番上に定義
			}

			if (webhookData.message.type == "image") {
				var messageId = webhookData.message.id;

				var imageBlob = getImageBlobByImageUrl("https://api.line.me/v2/bot/message/" + messageId + "/content", time);
				var imageUrl = saveImageBlobAsPng(imageBlob, groupId, message, time);

				message = imageUrl;

			}

			var userName = sendLineProfileFromUserName(userId);

			spreadsheet.getSheetByName(groupId).appendRow([userName, time, message]);
		}

		return sendLineMessageFromReplyToken(replyToken, message, time);
	}

	function sendLineProfileFromUserName(userId) {
		var profileUrl = "https://api.line.me/v2/bot/profile/" + userId;
		var res = UrlFetchApp.fetch(profileUrl, {
			'headers': {
				'Content-Type': 'application/json; charset=UTF-8',
				'Authorization': 'Bearer ' + channel_access_token,
			},
			'method': 'get'
		});

		return JSON.parse(res).displayName;
	}

	function sendLineMessageFromReplyToken(token, replyText, time) {
		var url = "https://api.line.me/v2/bot/message/reply";
		var headers = {
			"Content-Type": "application/json; charset=UTF-8",
			"Authorization": "Bearer " + channel_access_token
		};

		var postData = {
			"replyToken": token,
			"messages": [{
				"type": "text",
				"text": replyText
			}]
		};
		var options = {
			"method": "POST",
			"headers": headers,
			"payload": JSON.stringify(postData)
		};

		var response = UrlFetchApp.fetch(url, options);
		return response.getResponseCode();
	}

	/*
	Google Driveに LineBotで送られた画像を保存する
	1. ラインから画像を受け取る
	2. driveにgroup名のフォルダがあるかの確認
	3. あればそこに、なかったら新しくフォルダを生成
	4. フォルダに画像を保存
	*/

	function getImageBlobByImageUrl(imgUrl, time) {

		var res = UrlFetchApp.fetch(imgUrl, {
			'headers': {
				'Content-Type': 'application/json; charset=UTF-8',
				'Authorization': 'Bearer ' + channel_access_token,
			},
			'method': 'get'
		});

		var imageBlob = res.getBlob().getAs("image/png").setName("" + time);
		Logger.log("imageBlobの取得に成功しました");
		Logger.log("ContentType:" + imageBlob.getContentType());
		Logger.log("Name: " + imageBlob.getName());
		return imageBlob;
	}

	function saveImageBlobAsPng(imageBlob, groupId, message, time) {
		try {
			var folder = DriveApp.getFolderById("1g7FE5GVFv48hFolYfbIB67GAM4ERMFDl");// drive.google.com/drive/u/0/folders/XXXXXXXXXXXXXX 여기서XXXXXXXXXXXXXX가 폴더아이디됨


//folder配下のfolder全部
			var subFolders = folder.getFolders();
			var doesntExists = true;
			var newFolder = '';


// Check if folder already exists.
			while (subFolders.hasNext()) {
				var nextFolder = subFolders.next();

				if (nextFolder.getName() == groupId) {
					doesntExists = false;
					newFolder = nextFolder;
					break;
				}
			}
			;

			if (doesntExists == true) {
				newFolder = folder.createFolder(groupId);
			}

			var file = newFolder.createFile(imageBlob);
			var fileUrl = file.getUrl();

			Logger.log("file.getUrl():" + fileUrl);

			return fileUrl;
		} catch (e) {
			Logger.log("[ERROE]Google Driveに画像を保存できませんでした");
			Logger.log(e);
		}

	}
</script>
</body>
</html>
